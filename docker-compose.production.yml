version: '3.8'

services:
  redis:
    image: redis:alpine
    container_name: jarvis-redis
    restart: unless-stopped
    networks:
      - jarvis-shared
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes

  session-manager:
    image: session-manager:latest
    container_name: jarvis-session-manager
    restart: unless-stopped
    ports:
      - "9000:9000"  # Internal port only, not exposed externally
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - BACKEND_IMAGE=jarvis-backend-prod:latest
      - FRONTEND_IMAGE=jarvis-frontend:prod
      - MAX_TOTAL_SESSIONS=150
      - SESSION_TTL_HOURS=24
      - PORT_RANGE_START=10000
      - PORT_RANGE_END=20000
      # Production-specific settings
      - LOG_LEVEL=info
      - WORKSPACE_PATH=${WORKSPACE_PATH:-/app/workspace}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${WORKSPACE_PATH:-./}:/app/workspace:ro
    networks:
      - jarvis-shared
    depends_on:
      - redis

  nginx:
    image: nginx:alpine
    container_name: jarvis-nginx
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./landing:/usr/share/nginx/html:ro
      - ./admin-panel:/usr/share/nginx/admin:ro
      - ./nginx-production.conf:/etc/nginx/nginx.conf:ro
      # Optional: SSL certificates for HTTPS
      # - ./ssl:/etc/nginx/ssl:ro
      # Optional: Basic auth for admin panel
      # - ./.htpasswd:/etc/nginx/.htpasswd:ro
    networks:
      - jarvis-shared
    depends_on:
      - session-manager

networks:
  jarvis-shared:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  redis-data:
    driver: local